---
# SPDX-FileCopyrightText: Â© 2025 Olivier Meunier <olivier@neokraft.net>
#
# SPDX-License-Identifier: AGPL-3.0-only

withClient:
  parameters:
    - name: id
      in: path
      required: true
      description: Client ID
      schema:
        type: string
        format: short-uid
        example: cient_id
        description: The client ID received after registration
    - name: Authorization
      in: header
      required: true
      description: Access Token received after registration, passed as a `Bearer` value
      example: "Bearer registration_access_token"
      schema:
        type: string

  responses:
    "403":
      description: Wrong Client ID and/or Access Token

routes:
  /oauth/client:
    post:
      tags: [oauth client]
      security: []

      summary: Client Create
      description: |
        This route creates a new OAuth client. You must create a new client before you can request permissions and a token.

        Upon registration, you'll receive a `client_id` and an `registration_access_token`.
        You'll need them if you want to fetch, update or delete the client later.
        You must keep this information and store them as safely as a password.

        This route implements [RFC 7591: OAuth 2.0 Dynamic Client Registration Protocol](https://datatracker.ietf.org/doc/html/rfc7591).

        Client registration flow:
        ```
        +---------+                        +---------------+
        | Client  |                        | Registration  |
        +---------+                        +---------------+
            |                                     |
            | Client Registration Request         |
            | POST /api/oauth/client              |
            |------------------------------------>|
            |                                     |
            |         Client Information Response |
            |<------------------------------------|
            |                                     |
        ```

        Client management flow:
        ```
        +---------+                        +---------------+
        | Client  |                        | Registration  |
        +---------+                        +---------------+
            |                                     |
            | Client Information Request          |
            | GET /api/oauth/client/{id}          |
            |------------------------------------>|
            |                                     |
            |         Client Information Response |
            |<------------------------------------|
            |                                     |
            | Read or Update Request              |
            | GET or PUT /api/oauth/client/{id}   |
            |------------------------------------>|
            |                                     |
            |         Client Information Response |
            |<------------------------------------|
            |                                     |
            | Delete Request                      |
            | DELETE /api/oauth/client/{id}       |
            |------------------------------------>|
            |                                     |
            |                 Delete Confirmation |
            |<------------------------------------|
            |                                     |
        ```

        See also:

        - [Client Info](#get-/oauth/client/-id-)
        - [Client Update](#put-/oauth/client/-id-)
        - [Client Delete](#delete-/oauth/client/-id-)

        Here's, in Javascript, an example of a client flow for an app:

        ```js
        async function clientFlow() {
          // Where you store the client_id and registration_access_token
          const appVersion = "1.1.0"
          const store = {}
          let rsp

          if (!store.clientID) {
            // New client, create one
            rsp = await fetch(
              "__BASE_URI__/oauth/client",
              {
                "method": "POST",
                "body": json.Stringify({
                  "client_name": "My new client",
                  "client_uri": "https://example.org/",
                  "redirect_uris": [
                    "https://example.org/callback"
                  ],
                  "software_id": "some-uuid",
                  "software_version": "1.0.0",
                })
              },
            )
            let data = await rsp.json()
            store.clientID = data["client_id"]
            store.registrationAccessToken = data["registration_access_token"]

            // we're done
            return
          }

          // We have a client id, check if we need to update it
          rsp = await fetch(
            `__BASE_URI__/oauth/client/${store.clientID}`,
            {
              "headers": {"Authorization": `Bearer ${store.registrationAccessToken}`}
            },
          )
          let data = await rsp.json()

          if (data["software_version"] != appVersion) {
            // We need to update the client
            rsp = await fetch(
              `__BASE_URI__/oauth/client/${store.clientID}`,
              {
                "method": "PUT",
                "body": json.Stringify({
                  ...data,
                  "software_version": appVersion,
                }),
                "headers": {"Authorization": `Bearer ${store.registrationAccessToken}`}
              },
            )
            let data = await rsp.json()
          }
        }
        ```

      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/oauthClientCreate"

      responses:
        "201":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthClientResponse"

        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"

  /oauth/client/{id}:
    get:
      tags: [oauth client]
      $merge:
        - "#.withClient"
      security: []

      summary: Client Info
      description: |
        This route returns a registered client information. You must pass the received `registration_access_token`
        after creating the client in a `Authorization: Beare registration_access_token` header.

        This route implements [RFC 7592: OAuth 2.0 Dynamic Client Registration Management Protocol](https://datatracker.ietf.org/doc/html/rfc7592).

      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthClientResponse"

    put:
      tags: [oauth client]
      $merge:
        - "#.withClient"
      security: []

      summary: Client Update
      description: |
        This route updates an existing client.

        This route implements [RFC 7592: OAuth 2.0 Dynamic Client Registration Management Protocol](https://datatracker.ietf.org/doc/html/rfc7592).

      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/oauthClientUpdate"

      responses:
        "200":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthClientResponse"

        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"

    delete:
      tags: [oauth client]
      $merge:
        - "#.withClient"
      security: []

      summary: Client Delete
      description: |
        This route deletes an existing client.

        This route implements [RFC 7592: OAuth 2.0 Dynamic Client Registration Management Protocol](https://datatracker.ietf.org/doc/html/rfc7592).

      responses:
        "204":
          description: Deleted

  /oauth/token:
    post:
      tags: [oauth authorization]
      security: []

      summary: Access Token
      description: |
        A client must call this route once it received the necessary information from the
        redirect URI generated by the authorization route.

        ### Authorization

        The authorization route is: `__ROOT_URI__/authorize` and it receives the following
        query parameters:

        | Name                    | Description
        | :---------------------- | :-----------------------------
        | `client_id`             | OAuth Client ID
        | `redirect_uri`          | Redirection URI
        | `scope`                 | Space separated list of scopes
        | `code_challenge`        | PKCE Challenge
        | `code_challenge_method` | Only `S256` is allowed
        | `state`                 | Optional client state

        Sending a state is not mandatory but strongly advised to ensure that your side of the
        authorization flow has not been tampered.

        ### Authorization result

        Once a user grants or denies an authorization request, it will be redirected to the
        `redirect_uri` with the following query parameters:

        | Name    | Description
        | :------ | :--------------------------------------------------------------------
        | `code`  | The authorization code that the client must pass to the token request
        | `state` | The state as initially set by the client

        In case of error (request denied by the user or something else), the redirection contains
        the following query parameters:

        | Name                | Description
        | :------------------ | :--------------------------------------------------------------------
        | `error`             | Error code (can be `invalid_request` or `access_denied`)
        | `error_description` | Error description

        ### PKCE

        The authorization code flow requires that you use [PKCE](https://datatracker.ietf.org/doc/html/rfc7636)
        with an S256 method only (the "plain" method is not allowed).

        **Important**: The challenge must be base64 encoded, **with URL encoding** and **without padding**.

        Here's a Javascript example of a verifier and challenge generation:

        ```js
        function generateRandomString() {
          const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"
          let res = ""
          const buf = new Uint8Array(64)
          crypto.getRandomValues(buf)
          for (let i in buf) {
            res += alphabet[buf[i] % alphabet.length]
          }
          return res
        }

        async function pkceChallengeFromVerifier(v) {
          const b = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(v))
          return btoa(String.fromCharCode(...new Uint8Array(b)))
            .replaceAll("+", "-")
            .replaceAll("/", "_")
            .replaceAll("=", "")
        }

        const verifier = generateRandomString()
        pkceChallengeFromVerifier(verifier).then(challenge => {
          console.log(verifier)
          console.log(challenge)
        })
        ```

        ### Workflow

        Authorization flow:
        ```
        +-------+                +---------+                                 +---------------+    +-----+
        | User  |                | Client  |                                 | Authorization |    | API |
        +-------+                +---------+                                 +---------------+    +-----+
            |                         |                                              |               |
            | Enter instance URL      |                                              |               |
            |------------------------>|                                              |               |
            |                         |                                              |               |
            |                         | Generate PKCE verifier and challenge         |               |
            |                         |-------------------------------------         |               |
            |                         |                                    |         |               |
            |                         |<------------------------------------         |               |
            |                         |                                              |               |
            |                         | Open authorization URL                       |               |
            |                         | GET /authorize?...                           |               |
            |                         |--------------------------------------------->|               |
            |                         |                                              |               |
            |                                 Redirect to login/authorization prompt |               |
            |<-----------------------------------------------------------------------|               |
            |                         |                                              |               |
            | Authorize Client        |                                              |               |
            | POST /authorize?...                                                    |               |
            |----------------------------------------------------------------------->|               |
            |                         |                                              |               |
            |                         |                           Authorization code |               |
            |                         |<---------------------------------------------|               |
            |                         |                                              |               |
            |                         | Check state                                  |               |
            |                         |------------                                  |               |
            |                         |           |                                  |               |
            |                         |<-----------                                  |               |
            |                         |                                              |               |
            |                         | Request Token (with code and verifier)       |               |
            |                         | POST /api/oauth/token                        |               |
            |                         |--------------------------------------------->|               |
            |                         |                                              |               |
            |                         |                                              | Check PKCE    |
            |                         |                                              |-----------    |
            |                         |                                              |          |    |
            |                         |                                              |<----------    |
            |                         |                                              |               |
            |                         |                                 Access Token |               |
            |                         |<---------------------------------------------|               |
            |                         |                                              |               |
            |                         | Request data with Access Token               |               |
            |                         |------------------------------------------------------------->|
            |                         |                                              |               |
            |                         |                                              |      Response |
            |                         |<-------------------------------------------------------------|
            |                         |                                              |               |
        ```



      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/oauthTokenCreate"

      responses:
        "201":
          description: Access Token
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthTokenResponse"

        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"

  /oauth/revoke:
    post:
      tags: [oauth authorization]
      security: []

      summary: Revoke Token
      description: |
        This route lets a client revokes an access token. It must authenticate using its
        `registration_access_token` and provides the access token to revoke.

        You can use this route if you want to provide a log-out option to users.

      parameters:
        - name: Authorization
          in: header
          required: true
          description: Client Registration Access Token, passed as a `Bearer` value
          example: "Bearer registration_access_token"
          schema:
            type: string

      requestBody:
        content:
          application/json:
            schema:
              required: [token]
              properties:
                token:
                  type: string
                  description: Access token to revoke

      responses:
        "200":
          description: Access token revoked

        "400":
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/oauthError"